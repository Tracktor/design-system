name: Chromatic

on:
  pull_request:
    types: [opened, reopened, synchronize]

  issue_comment:
    types: [created]

jobs:
  # ---------------------------
  # 1) Post the "Run Chromatic" button
  # ---------------------------
  post-button:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request.number;
            const { owner, repo } = context.repo;

            const body = `ðŸ§ª **Visual regression tests**

Click to run Chromatic:

  [â–¶ Run Chromatic](https://github.com/${owner}/${repo}/issues/${pr}#issuecomment-new)
  
  *(Clicking this will post the magic command automatically)*`;
  
  await github.rest.issues.createComment({
  owner,
  repo,
issue_number: pr,
  body
});

# ---------------------------
# 2) Run Chromatic when button is clicked
# ---------------------------
chromatic:
  if: |
    github.event_name == 'issue_comment' &&
    github.event.issue.pull_request &&
    github.event.comment.body == 'RUN_CHROMATIC'

  runs-on: ubuntu-latest

  steps:
    - name: Checkout PR
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: refs/pull/${{ github.event.issue.number }}/head

    - uses: oven-sh/setup-bun@v1

    - uses: actions/cache@v4
      with:
        path: |
          ~/.bun/install/cache
          node_modules
        key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}

    - name: Install deps
      run: bun install --ignore-scripts

    - name: Build Storybook
      run: bun run build-storybook

    - name: Run Chromatic
      run: |
        npx chromatic \
          --project-token=c9bbc986d0d6 \
          --storybook-build-dir=storybook-static \
          --ci
